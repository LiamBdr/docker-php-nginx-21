# HTTP — healthcheck + redirect HTTPS
<VirtualHost *:80>
    ServerName localhost

    # Healthcheck endpoint
    <Location /health>
        SetHandler server-status
        Require all granted
    </Location>
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/health$
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined
</VirtualHost>

# HTTPS — Symfony application
<VirtualHost *:443>
    ServerName localhost

    SSLEngine on
    SSLCertificateFile /etc/apache2/ssl/server.crt
    SSLCertificateKeyFile /etc/apache2/ssl/server.key

    DocumentRoot /var/www/html/public

    <Directory /var/www/html/public>
        AllowOverride None
        Require all granted
        FallbackResource /index.php
    </Directory>

    # Proxy PHP vers php-fpm
    <FilesMatch \.php$>
        SetHandler "proxy:fcgi://127.0.0.1:9000"
    </FilesMatch>

    # Bloquer les fichiers PHP hors front-controller
    <LocationMatch "^/(?!index\.php).*\.php$">
        Require all denied
    </LocationMatch>

    # Bloquer les dotfiles
    <DirectoryMatch "/\.">
        Require all denied
    </DirectoryMatch>

    # Bloquer le répertoire var/
    <LocationMatch "^/var/">
        Require all denied
    </LocationMatch>

    # Cache headers pour assets statiques
    <FilesMatch "\.(jpg|jpeg|gif|png|css|js|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    ErrorLog /dev/stderr
    CustomLog /dev/stdout combined
</VirtualHost>
